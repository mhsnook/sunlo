# Sprint Doc

## Completed items list:

Update this list with complexity and difficulty scores after completing an item.

- (c1, d1) A. Fix: Embeds not working in production (bdd0e7e9)
- (c1, d1) AB. Fix: Poor RLS performance for chat messages (16b3f200)
- (c1, d1) B. Feature: Add Dyslexie/OpenDyslexic font support (8ca64970)
- (c1, d2) Feature L: Browse page search box, w filters (bc04dc1a)

## Instructions for the coding agent

Under normal circumstances:

- See the document: `@/contexts/instructions-for-coding-agent.md`

If you have been instructed to do a BIG TASKS PASS, do one thing differently: start first by looking at the items that require analysis and that have a complexity of 3 or 4. Otherwise, work through the doc item by item as instructed, leaving your analysis and plans on these items and moving on.

## Items to Work On

### A. Fix: Embeds not working in production

STATUS: COMPLETED
COMPLEXITY: 1
DIFFICULTY: 1

NOTE FROM HUMAN MANAGER: Embeds are working on localhost but not in production. Getting these browser console errors:

```
Blocked script execution in 'https://www.youtube.com/embed/2lk97RmZNf8' because the document's frame is sandboxed and the 'allow-scripts' permission is not set.Understand this error
Blocked script execution in 'https://open.spotify.com/embed/episode/7camUCOPmHHa1Mu4lSdI3L' because the document's frame is sandboxed and the 'allow-scripts' permission is not set.
```

WORK DONE: Added `allow-scripts` to the iframe sandbox attribute in `playlist-embed.tsx` for YouTube, Spotify, and SoundCloud embeds. Commit: b87ecb1f

### B. Feature: Add Dyslexie support in the profile options

STATUS: COMPLETED
COMPLEXITY: 1
DIFFICULTY: 1

NOTE FROM HUMAN MANAGER: This probably means: adding dyslexie as a font option in globals.css, moving `Instrument Sans` from the default "sans" font to just a font called `instrument` and then using a class on the body to set whether `sans -> instrument` or `sans -> dyslexie`. Then the profile can just get another field on it and a toggle input/form (self-submitting) which updates that field in the DB.

WORK DONE: Added OpenDyslexic font support with migration for `font_preference` column, CSS font switching via body class, display preferences section in profile with self-submitting toggle, and localStorage sync for faster initial load. Commit: 8ca64970

### Feature E: Friends feed and Popular feed should become polymorphic like the recent feed, and Filters should work there too

STATUS: PENDING
COMPLEXITY: 2

NOTE: The router's fallback loading component wasn't using the standard Loader component; switching to that fixed it.

### Feature Research H: User Consents and GDPR

STATUS: PENDING
COMPLEXITY: 1 or 3

HUMAN MANAGER COMMENT: Now that we have a "public mode" we have an increased responsibility and urgency around implementing some more explicit permissions and consents. For example, the privacy policy in `privacy-policy.tsx` specifies that phrases and translations will be public, but we should make this more clear that e.g. comment threads, requests and playlists are also part of the public resources. Which cards you're learning and your review history are private, but many of these other things can be read by the public. Giving some checkbox notification of this, on the signup form, should be a simple client-side change (complexity 1).

And in time we also need to implement some GDPR compliance, which means having a model for consents and consent-agreement actions that can be tied back to the version of the policy that was being consented to. Which means probbly moving the privacy policy into the database as markdown and versioning it and so on. This will be a much more involved project than simply better notifying the users about sharing information in public, and should be well thought out before we begin.

### Feature I: Sign in with Google Auth

STATUS: Pending
COMPLEXITY: 2

HUMAN MANAGER COMMENT: This may require some back-and-forth with Supabase setup and configuration, and then writing code. And we may need to give individuals a way to switch from password-auth to google-auth.

### DX J: Explain what it would take to set up GH Actions to run tests

STATUS: Pending
COMPLEXITY: 2

HUMAN MANAGER COMMENT: This may look like a complexity 1 ("set up a github action") but we have to be very careful never to run the tests against the production branch. We need to run them against the `next` branch and against PRs targeting `next` and against any deployment PRs (from `next` to `main`). The action needs to be able to use secrets that are synced from Supabase's branch management system, or if that proves to complex, use secrets that work for the `next` branch, and use supabse's persistent `next` branch to achieve the best coverage within our limitations. Please collect a few reasonable options and present them. Go with a minimal solution that works first; a basic POC that is safe and reliable and uses the `next` branch only, and we can do that first, and then we'll work on better test reliability (or else our new CI pipeline will shut down all deployments!) and then we'll think about other DX improvements in a later scope of work. Don't make any code changes yet; simply write a plan in this doc.

### DX K: A set of tests that don't make database changes; ignores the `mutations` folder and uses a different `navigations` folder which just steps through the app, allowing decs to run these tests frequenty without a db reset, using `pnpm test no-db`

STATUS: Pending
COMPLEXITY: 2

NOTE FROM HUMAN MANAGER: We can mostly copy the navigation commands from existing "mutations" tests, and just leave out the form stuff. And we can just click around key workflows and make sure everything works. Maybe you have a smart way of just "crawling" the app from both logged-in and logged-out perspectives and spotting anything unusual.

### Feature L: Browse page needs a big "search" box up at the top

STATUS: COMPLETED
COMPLEXITY: 1
DIFFICULTY: 1

NOTE FROM HUMAN MANAGER: The "browse" page is really kind of crying out for a "search" box right there up at the top which searches all the phrases and translations and requests and playlists in the local DB. See `phraseFull` collection's `searchableText` field for a head start on this (but playlists are not integrated there at this time).

WORK DONE: Added prominent search input at top of browse page that searches across phrases (text, translations, tags), playlists (title, description), and requests (prompt). Results shown in categorized sections with counts. Added tags and languages filters. (bc04dc1a)

### L. Fix: When you get login-requred intercepted on the add-phrase page and then log in, the sidebar does not update unless you refresh

STATUS: Pending
COMPLEXITY: 2

#### NOTE FROM HUMAN MANAGER

This login results in a whole bunch of this console warning from tanstack/db:

> [Live Query Error] Source collection 'my_profile' was manually cleaned up while live query 'live-query-4' depends on it. Live queries prevent automatic GC, so this was likely a manual cleanup() call.

And

> [Live Query Error] Source collection 'decks' was manually cleaned up while live query 'live-query-9' depends on it. Live queries prevent automatic GC, so this was likely a manual cleanup() call.

And so on.

### S. Feature: Reverse Reviews

STATUS: Still defining the problem / desired behaviour
COMPLEXITY: 2

NOTE FROM HUMAN MANAGER: the card shouldn't always be shown on the front, should it? sometimes we need to see the translation and remember the phrase (or see the request??). What do you think?

### V. Fix: When you try to "sign up" using credentials of an existing user, you get an error but then still get logged in. We should probably inspect these errors, and if it's this specific case, just log you in and don't throw the error/toast.

STATUS: PENDING
COMPLEXITY: 1

### W. Feature: Edit or soft-delete your own translations

STATUS: PENDING
COMPLEXITY: 2

NOTE FROM HUMAN MANAGER: This should be a simple update call (no RPC needed) to edit the translation item, and then we have to do a tiny bit of fanciness to update the local Phrase item with just the translation we've changed (or to remove it), and update the `phrase_translation` RLS so that archived/deleted rows don't show up. So it all seems very small but several layers must be done together.

### X. Chore: 1. Replace the friend request / accept / cancel logic with a dedicated RPC

STATUS: PENDING
COMPLEXITY: 2 (simple enough, but requires migrations and checking state/idempotence/edge cases (like both people sending requests at the same time))

### AB. Fix: Poor performance in RLS for chat messages

STATUS: COMPLETED
COMPLEXITY: 1
DIFFICULTY: 1

NOTE FROM SECURITY ANALYST: Issue is that the table `public.chat_message` has a row level security policy `Users can send messages to friends` that re-evaluates `current_setting()` or `auth.<function>()` for each row. This produces suboptimal query performance at scale. Resolve the issue by replacing `auth.<function>()` with `(select auth.<function>())`. See docs for more info.

WORK DONE: Created migration `20260115120000_fix_chat_message_rls_performance.sql` that drops and recreates both RLS policies with `(select auth.uid())` instead of `auth.uid()`. Commit: 95b1f4f3

### AC. Chore: Convert RPCs from now-deprecated PLv8 fns to PLpgpsql

## Items that still need to be figured out

Feeds Work Cleanup tasks:

2. Need to be able to "repost" a Request to a new language
3. Playlists should have an image option if you don't have an external source with og:image

EPIC: Postgres DX / Run Supabase Locally

1. make the email stuff work with the local setup
1. pgTap set up testing framework / run tests on the RPC functions: https://supabase.com/docs/guides/database/extensions/pgtap
1. future:
   - use postmark templates like [this](https://github.com/supabase/auth/issues/304#issuecomment-998029660)

EPIC OF SIGNUPS AND GETTING STARTED AND CONNECTING FRIENDS

1. ~make the signup email nice~

EDGE CASES LEFT BEHIND

1. When you reach the getting-started page with no "user role" set
   - rn the redirect pretends you're a helper
   - we should probably ask ppl instead
   - we should really do away with this "helper" distinction altogether I think? or move it to the deck setup

MOCKS / Incompletes

1. Friends activity ?? (maybe doesn't belong here) - wire it up - move the Quick Search link into the navbar??
1. Public Library is a special browsing experience that needs to be built!
   1. $lang/library has this "recently reviewed" filter which probably should be a field on the user_card_plus view
   1. $lang/index needs the review overview graph thing made

CARD INTERACTIONS

1. "suggest edits to this card"
   - Plan: Allow any logged-in user to submit a change to the `edit_suggestions` table.
1. "edit" feature for editing translations and phrases. a user deck assigns the user's relationship to the language, are they no-relation, curious, learner, friend, teacher, or editor. in this example, editor is the high mark, like an admin.
   - Plan: Users with `editor` role can directly modify records, which calls an `update_*` RPC.
1. "edit history" where you can see the previous edits and timestamps and who edited them.
   - Plan: Create `phrase_versions` and `translation_versions` tables. Edits will create a new version record. A "History" tab will be added to the card UI.

UI POLISH

1. Full multilingual text search:
   - PGroonga: https://supabase.com/docs/guides/database/extensions/pgroonga
   - fulltext search without accents: https://www.postgresql.org/docs/current/unaccent.html
   - â›” fuzzy string match that only works well with american names: https://www.postgresql.org/docs/current/fuzzystrmatch.html
1. This chat's features: https://v0.dev/chat/animated-card-interface-MHacnAB0fOp
   1. slide the cards in and out horizontally
   1. give us a completion progress bar in the /review interface
1. when the router loader is suspending and then stops, transition in

OTHER IDEAS

1. a app shortcut that opens straight into new-card interface
1. take a picture, do OCR on it, let people create a card directly from the real world
1. record voicenote, extract card(s) from it, like making your own playlist on the spot
1. Prettier URLs? with hashIDs (can hash the uuid): https://supabase.com/docs/guides/database/extensions/pg_hashids
